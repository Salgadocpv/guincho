<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Iguincho - Navega√ß√£o</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            height: 100vh;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        /* Navigation Header */
        .navigation-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 150;
            background: linear-gradient(180deg, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.4) 80%, transparent 100%);
            padding: 12px 16px 8px 16px;
            text-align: center;
            color: white;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .back-button {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(0,0,0,0.6);
            border-color: rgba(255,255,255,0.5);
        }

        .stop-navigation {
            background: rgba(220, 53, 69, 0.8);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .stop-navigation:hover {
            background: rgba(220, 53, 69, 1);
        }

        .navigation-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .navigation-subtitle {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.8);
        }

        .navigation-distance {
            font-size: 0.75rem;
            color: rgba(40,167,69,1);
            margin-top: 2px;
            font-weight: 600;
        }

        /* Map Container */
        .map-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Loading Screen */
        .map-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 10;
            color: white;
        }

        .map-loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top: 3px solid #1E90FF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        .map-loading-text {
            color: white;
            font-size: 1rem;
            text-align: center;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Bottom Info Panel */
        .bottom-info {
            position: fixed;
            bottom: 12px;
            left: 12px;
            right: 12px;
            z-index: 100;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 12px;
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .route-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }

        .route-stat {
            text-align: center;
            flex: 1;
        }

        .route-stat-label {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 2px;
        }

        .route-stat-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1E90FF;
        }

        .current-instruction {
            text-align: center;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.9);
            line-height: 1.3;
        }
    </style>
</head>
<body>
    <!-- Map Container -->
    <div class="map-container">
        <div class="map-loading" id="mapLoading">
            <div class="map-loading-spinner"></div>
            <div class="map-loading-text">
                Iniciando navega√ß√£o...<br>
                <small>Carregando rota e GPS</small>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <!-- Navigation Header -->
    <div class="navigation-header">
        <div class="header-top">
            <button class="back-button" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <button class="stop-navigation" onclick="stopNavigation()">
                <i class="fas fa-stop"></i> Parar
            </button>
        </div>
        <div class="navigation-title">Navegando para destino</div>
        <div class="navigation-subtitle" id="navigationSubtitle">Siga as instru√ß√µes do mapa</div>
        <div class="navigation-distance" id="navigationDistance">Calculando rota...</div>
    </div>

    <!-- Bottom Info Panel -->
    <div class="bottom-info">
        <div class="route-info">
            <div class="route-stat">
                <div class="route-stat-label">Dist√¢ncia</div>
                <div class="route-stat-value" id="totalDistance">-</div>
            </div>
            <div class="route-stat">
                <div class="route-stat-label">Tempo</div>
                <div class="route-stat-value" id="totalTime">-</div>
            </div>
            <div class="route-stat">
                <div class="route-stat-label">Chegada</div>
                <div class="route-stat-value" id="arrivalTime">-</div>
            </div>
        </div>
        
        <div class="current-instruction" id="currentInstruction">
            Inicializando navega√ß√£o...
        </div>
    </div>

    <!-- Google Maps API -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5CfnBBfbxBT0xLLpQxFNUCwA3DmVZilE&callback=initNavigation&libraries=geometry,places">
    </script>

    <script>
        // Global variables
        let map;
        let directionsService;
        let directionsRenderer;
        let userLocation;
        let destinationLocation;
        let originAddress;
        let destinationAddress;
        let userMarker = null;
        let currentHeading = 0;

        // Initialize navigation from URL parameters
        function initNavigation() {
            console.log('üöÄ initNavigation called!');
            
            // Get parameters from URL
            const urlParams = new URLSearchParams(window.location.search);
            
            // Parse coordinates
            const originLat = parseFloat(urlParams.get('originLat'));
            const originLng = parseFloat(urlParams.get('originLng'));
            const destLat = parseFloat(urlParams.get('destLat'));
            const destLng = parseFloat(urlParams.get('destLng'));
            
            // Parse addresses
            try {
                originAddress = decodeURIComponent(urlParams.get('originAddress') || 'Origem');
            } catch (e) {
                originAddress = urlParams.get('originAddress') || 'Origem';
            }
            
            try {
                destinationAddress = decodeURIComponent(urlParams.get('destAddress') || 'Destino');
            } catch (e) {
                destinationAddress = urlParams.get('destAddress') || 'Destino';
            }
            
            // Validate parameters
            if (isNaN(originLat) || isNaN(originLng) || isNaN(destLat) || isNaN(destLng)) {
                alert('Par√¢metros de navega√ß√£o inv√°lidos. Retornando...');
                goBack();
                return;
            }
            
            userLocation = { lat: originLat, lng: originLng };
            destinationLocation = { lat: destLat, lng: destLng };
            
            console.log('Navigation initialized:', { userLocation, destinationLocation });
            
            // Update page title
            document.getElementById('navigationSubtitle').textContent = `Para: ${destinationAddress}`;
            
            // Initialize map
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: userLocation,
                mapTypeId: 'roadmap',
                disableDefaultUI: true,
                gestureHandling: 'greedy'
            });

            // Initialize directions service
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#1E90FF',
                    strokeWeight: 6,
                    strokeOpacity: 1.0
                }
            });
            
            directionsRenderer.setMap(map);
            
            // Create user marker (blue arrow)
            createUserMarker();
            
            // Initialize compass
            initializeCompass();
            
            // Hide loading and start navigation
            document.getElementById('mapLoading').style.display = 'none';
            
            // Start navigation immediately
            startNavigation();
        }

        // Start navigation with route calculation
        function startNavigation() {
            const request = {
                origin: userLocation,
                destination: destinationLocation,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC
            };

            directionsService.route(request, function(result, status) {
                if (status === 'OK') {
                    // Display route
                    directionsRenderer.setDirections(result);
                    
                    // Update UI with route info
                    updateNavigationInfo(result);
                    
                    console.log('Navigation started successfully');
                } else {
                    alert('N√£o foi poss√≠vel calcular a rota: ' + status);
                    goBack();
                }
            });
        }

        // Update navigation information
        function updateNavigationInfo(result) {
            const route = result.routes[0];
            const leg = route.legs[0];
            
            // Update distance and time
            document.getElementById('totalDistance').textContent = leg.distance.text;
            document.getElementById('totalTime').textContent = leg.duration.text;
            
            // Calculate arrival time
            const now = new Date();
            const arrivalTime = new Date(now.getTime() + leg.duration.value * 1000);
            document.getElementById('arrivalTime').textContent = arrivalTime.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Update instruction
            if (leg.steps && leg.steps.length > 0) {
                const firstStep = leg.steps[0];
                document.getElementById('currentInstruction').innerHTML = firstStep.instructions || 'Siga em frente';
            }
            
            // Update header distance
            document.getElementById('navigationDistance').textContent = leg.distance.text;
        }

        // Create user marker (blue arrow)
        function createUserMarker() {
            if (userMarker) {
                userMarker.setMap(null);
            }
            
            userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                icon: {
                    // Blue arrow pointing up
                    path: 'M0,-20 L-8,8 L0,3 L8,8 Z',
                    fillColor: '#1E90FF',
                    fillOpacity: 1.0,
                    strokeColor: '#FFFFFF',
                    strokeWeight: 2,
                    scale: 1.5,
                    anchor: new google.maps.Point(0, 0),
                    rotation: 0 // Always points up (north)
                },
                zIndex: 1000,
                optimized: false
            });
        }

        // Initialize compass to rotate map based on device orientation
        function initializeCompass() {
            if ('DeviceOrientationEvent' in window) {
                // Request permission for iOS 13+
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                startCompassTracking();
                            }
                        })
                        .catch(console.error);
                } else {
                    // For other devices
                    startCompassTracking();
                }
            }
        }

        // Start tracking device orientation for compass
        function startCompassTracking() {
            // Use deviceorientationabsolute for more accurate compass on supported devices
            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', handleDeviceOrientation, true);
            } else {
                window.addEventListener('deviceorientation', handleDeviceOrientation, true);
            }
        }

        // Handle device orientation changes
        function handleDeviceOrientation(event) {
            if (event.alpha !== null) {
                // Get the compass heading
                let heading = event.alpha;
                
                // For iOS, we need to adjust
                if (event.webkitCompassHeading) {
                    heading = event.webkitCompassHeading;
                }
                
                // Convert to 0-360 range
                heading = (360 - heading) % 360;
                
                currentHeading = heading;
                
                // Rotate the map so that the user's direction faces up
                if (map) {
                    map.setHeading(heading);
                }
            }
        }

        // Navigation controls
        function goBack() {
            window.history.back();
        }

        function stopNavigation() {
            if (confirm('Deseja parar a navega√ß√£o?')) {
                goBack();
            }
        }

        // Handle Google Maps API authentication errors
        window.gm_authFailure = function() {
            console.error('‚ùå Google Maps API authentication failed');
            document.getElementById('mapLoading').innerHTML = `
                <div style="color: white; text-align: center;">
                    <i class="fas fa-key" style="font-size: 2rem; margin-bottom: 1rem; color: #dc3545;"></i><br>
                    Erro de autentica√ß√£o do mapa<br>
                    <small>Chave da API inv√°lida ou expirada</small><br>
                    <button onclick="goBack()" style="margin-top: 1rem; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">Voltar</button>
                </div>
            `;
        };
    </script>
</body>
</html>