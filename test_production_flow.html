<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Completo - Cliente ‚Üí Guincheiro - Produ√ß√£o</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 20px auto; 
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #007bff; text-align: center; }
        h2 { color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 10px; }
        .step {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        button:hover { opacity: 0.8; }
        .status-panel {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .panel {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .log {
            background: #212529;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Teste Completo: Cliente ‚Üí Guincheiro</h1>
        <h2>Ambiente: PRODU√á√ÉO - www.coppermane.com.br/guincho</h2>
        
        <div class="step">
            <strong>Objetivo:</strong> Testar o fluxo completo onde um cliente cria uma solicita√ß√£o e verifica se aparece para o guincheiro
        </div>

        <button class="btn-primary" onclick="runCompleteTest()">üß™ Executar Teste Completo</button>
        <button class="btn-info" onclick="testClientLogin()">üë§ Testar Login Cliente</button>
        <button class="btn-success" onclick="testDriverLogin()">üöõ Testar Login Guincheiro</button>
        <button class="btn-warning" onclick="createTestTrip()">üìç Criar Solicita√ß√£o Teste</button>
        <button class="btn-danger" onclick="clearResults()">üßπ Limpar</button>
    </div>

    <div class="status-panel">
        <div class="panel">
            <h3>üßë‚Äçüíº Status do Cliente</h3>
            <div id="clientStatus">Aguardando teste...</div>
            <div id="clientResult" class="result info">Pronto para testar</div>
        </div>
        
        <div class="panel">
            <h3>üöõ Status do Guincheiro</h3>
            <div id="driverStatus">Aguardando teste...</div>
            <div id="driverResult" class="result info">Pronto para testar</div>
        </div>
    </div>

    <div class="container">
        <h3>üìã Log de Execu√ß√£o</h3>
        <div id="executionLog" class="log">Sistema pronto para testes...\n</div>
    </div>

    <script>
        let clientToken = null;
        let driverToken = null;
        let tripRequestId = null;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('executionLog');
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(type, status, resultClass, message) {
            document.getElementById(`${type}Status`).textContent = status;
            const resultDiv = document.getElementById(`${type}Result`);
            resultDiv.className = `result ${resultClass}`;
            resultDiv.textContent = message;
        }

        async function testClientLogin() {
            log('üßë‚Äçüíº Iniciando teste de login do cliente...');
            updateStatus('client', 'Fazendo login...', 'info', 'Conectando...');
            
            try {
                const response = await fetch('/guincho/api/auth/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'cliente@iguincho.com',
                        password: 'teste123'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    clientToken = data.data.session_token;
                    updateStatus('client', 'Logado com sucesso', 'success', 
                        `‚úÖ ${data.data.user.full_name}\nID: ${data.data.user.id}\nTipo: ${data.data.user.user_type}`);
                    log(`‚úÖ Cliente logado: ${data.data.user.full_name} (${data.data.user.email})`);
                    return true;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                updateStatus('client', 'Erro no login', 'error', `‚ùå ${error.message}`);
                log(`‚ùå Erro no login do cliente: ${error.message}`);
                return false;
            }
        }

        async function testDriverLogin() {
            log('üöõ Iniciando teste de login do guincheiro...');
            updateStatus('driver', 'Fazendo login...', 'info', 'Conectando...');
            
            try {
                const response = await fetch('/guincho/api/auth/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'guincheiro@teste.com',
                        password: 'teste123'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    driverToken = data.data.session_token;
                    updateStatus('driver', 'Logado com sucesso', 'success', 
                        `‚úÖ ${data.data.user.full_name}\nID: ${data.data.user.id}\nTipo: ${data.data.user.user_type}`);
                    log(`‚úÖ Guincheiro logado: ${data.data.user.full_name} (${data.data.user.email})`);
                    return true;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                updateStatus('driver', 'Erro no login', 'error', `‚ùå ${error.message}`);
                log(`‚ùå Erro no login do guincheiro: ${error.message}`);
                return false;
            }
        }

        async function createTestTrip() {
            if (!clientToken) {
                log('‚ùå Token do cliente necess√°rio para criar viagem');
                return false;
            }
            
            log('üìç Criando solicita√ß√£o de viagem de teste...');
            updateStatus('client', 'Criando solicita√ß√£o...', 'warning', 'Enviando dados...');
            
            try {
                const tripData = {
                    service_type: 'guincho',
                    origin_lat: -23.5505,
                    origin_lng: -46.6333,
                    origin_address: 'Pra√ßa da S√©, S√£o Paulo, SP',
                    destination_lat: -23.5629,
                    destination_lng: -46.6544,
                    destination_address: 'Parque Ibirapuera, S√£o Paulo, SP',
                    client_offer: 85.00
                };
                
                const response = await fetch('/guincho/api/trips/create_request.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + clientToken
                    },
                    body: JSON.stringify(tripData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    tripRequestId = data.data.trip_request_id;
                    updateStatus('client', 'Solicita√ß√£o criada', 'success', 
                        `‚úÖ ID: ${tripRequestId}\nüí∞ R$ ${tripData.client_offer}\nüìç ${data.data.distance_km} km\nüë• ${data.data.nearby_drivers_count} guincheiros notificados`);
                    log(`‚úÖ Solicita√ß√£o criada com ID: ${tripRequestId}`);
                    log(`üìä Detalhes: ${data.data.distance_km} km, R$ ${tripData.client_offer}, ${data.data.nearby_drivers_count} guincheiros notificados`);
                    return true;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                updateStatus('client', 'Erro na solicita√ß√£o', 'error', `‚ùå ${error.message}`);
                log(`‚ùå Erro ao criar solicita√ß√£o: ${error.message}`);
                return false;
            }
        }

        async function checkDriverRequests() {
            if (!driverToken) {
                log('‚ùå Token do guincheiro necess√°rio para verificar solicita√ß√µes');
                return false;
            }
            
            log('üîç Verificando solicita√ß√µes dispon√≠veis para o guincheiro...');
            updateStatus('driver', 'Buscando solicita√ß√µes...', 'info', 'Consultando...');
            
            try {
                const response = await fetch('/guincho/api/trips/get_requests.php', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + driverToken
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const requests = data.data || [];
                    const testRequest = requests.find(req => req.id == tripRequestId);
                    
                    if (testRequest) {
                        updateStatus('driver', 'Solicita√ß√£o encontrada!', 'success', 
                            `‚úÖ Solicita√ß√£o ${tripRequestId} vis√≠vel\nüìç ${testRequest.origin_address}\nüí∞ R$ ${testRequest.client_offer}\nüìè ${testRequest.distance_km} km`);
                        log(`‚úÖ SUCESSO! Solicita√ß√£o ${tripRequestId} apareceu para o guincheiro`);
                        log(`üìç Origem: ${testRequest.origin_address}`);
                        log(`üéØ Destino: ${testRequest.destination_address}`);
                        return true;
                    } else {
                        updateStatus('driver', 'Solicita√ß√£o n√£o encontrada', 'warning', 
                            `‚ö†Ô∏è ${requests.length} solicita√ß√µes dispon√≠veis\nMas a solicita√ß√£o ${tripRequestId} n√£o est√° vis√≠vel`);
                        log(`‚ö†Ô∏è Solicita√ß√£o ${tripRequestId} N√ÉO encontrada entre ${requests.length} dispon√≠veis`);
                        if (requests.length > 0) {
                            log(`üìã Solicita√ß√µes dispon√≠veis: ${requests.map(r => r.id).join(', ')}`);
                        }
                        return false;
                    }
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                updateStatus('driver', 'Erro na consulta', 'error', `‚ùå ${error.message}`);
                log(`‚ùå Erro ao consultar solicita√ß√µes: ${error.message}`);
                return false;
            }
        }

        async function runCompleteTest() {
            log('üß™ Iniciando teste completo do fluxo Cliente ‚Üí Guincheiro');
            log('=' + '='.repeat(50));
            
            // Etapa 1: Login do Cliente
            log('üìç ETAPA 1: Login do Cliente');
            const clientLoggedIn = await testClientLogin();
            if (!clientLoggedIn) {
                log('‚ùå TESTE FALHOU: N√£o foi poss√≠vel fazer login do cliente');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Etapa 2: Login do Guincheiro
            log('üìç ETAPA 2: Login do Guincheiro');
            const driverLoggedIn = await testDriverLogin();
            if (!driverLoggedIn) {
                log('‚ùå TESTE FALHOU: N√£o foi poss√≠vel fazer login do guincheiro');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Etapa 3: Cliente cria solicita√ß√£o
            log('üìç ETAPA 3: Cliente cria solicita√ß√£o');
            const tripCreated = await createTestTrip();
            if (!tripCreated) {
                log('‚ùå TESTE FALHOU: N√£o foi poss√≠vel criar a solicita√ß√£o');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Etapa 4: Verificar se aparece para o guincheiro
            log('üìç ETAPA 4: Verificar se aparece para o guincheiro');
            const requestVisible = await checkDriverRequests();
            
            // Resultado final
            log('=' + '='.repeat(50));
            if (requestVisible) {
                log('üéâ TESTE COMPLETO PASSOU! ‚úÖ');
                log('   ‚úÖ Cliente conseguiu fazer login');
                log('   ‚úÖ Guincheiro conseguiu fazer login');
                log('   ‚úÖ Cliente criou solicita√ß√£o com sucesso');
                log('   ‚úÖ Solicita√ß√£o apareceu para o guincheiro');
                log('');
                log('üöÄ SISTEMA FUNCIONANDO PERFEITAMENTE EM PRODU√á√ÉO!');
            } else {
                log('‚ùå TESTE FALHOU!');
                log('   ‚úÖ Cliente conseguiu fazer login');
                log('   ‚úÖ Guincheiro conseguiu fazer login');
                log('   ‚úÖ Cliente criou solicita√ß√£o com sucesso');
                log('   ‚ùå Solicita√ß√£o N√ÉO apareceu para o guincheiro');
                log('');
                log('üîß NECESS√ÅRIO INVESTIGAR O SISTEMA DE NOTIFICA√á√ïES');
            }
        }
        
        function clearResults() {
            document.getElementById('executionLog').textContent = 'Sistema pronto para testes...\n';
            updateStatus('client', 'Aguardando teste...', 'info', 'Pronto para testar');
            updateStatus('driver', 'Aguardando teste...', 'info', 'Pronto para testar');
            clientToken = null;
            driverToken = null;
            tripRequestId = null;
        }

        // Auto-run test if in production
        if (window.location.hostname.includes('coppermane')) {
            log('üåç Detectado ambiente de PRODU√á√ÉO - Iniciando teste autom√°tico em 3 segundos...');
            setTimeout(runCompleteTest, 3000);
        }
    </script>
</body>
</html>