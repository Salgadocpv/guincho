<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Completo - Cliente â†’ Guincheiro - ProduÃ§Ã£o</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 20px auto; 
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #007bff; text-align: center; }
        h2 { color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 10px; }
        .step {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        button:hover { opacity: 0.8; }
        .status-panel {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .panel {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .log {
            background: #212529;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš— Teste Completo: Cliente â†’ Guincheiro</h1>
        <h2>Ambiente: PRODUÃ‡ÃƒO - www.coppermane.com.br/guincho</h2>
        
        <div class="step">
            <strong>Objetivo:</strong> Testar o fluxo completo onde um cliente cria uma solicitaÃ§Ã£o e verifica se aparece para o guincheiro
        </div>

        <button class="btn-primary" onclick="runCompleteTest()">ğŸ§ª Executar Teste Completo</button>
        <button class="btn-info" onclick="testClientLogin()">ğŸ‘¤ Testar Login Cliente</button>
        <button class="btn-success" onclick="testDriverLogin()">ğŸš› Testar Login Guincheiro</button>
        <button class="btn-warning" onclick="createTestTrip()">ğŸ“ Criar SolicitaÃ§Ã£o Teste</button>
        <button class="btn-danger" onclick="clearResults()">ğŸ§¹ Limpar</button>
    </div>

    <div class="status-panel">
        <div class="panel">
            <h3>ğŸ§‘â€ğŸ’¼ Status do Cliente</h3>
            <div id="clientStatus">Aguardando teste...</div>
            <div id="clientResult" class="result info">Pronto para testar</div>
        </div>
        
        <div class="panel">
            <h3>ğŸš› Status do Guincheiro</h3>
            <div id="driverStatus">Aguardando teste...</div>
            <div id="driverResult" class="result info">Pronto para testar</div>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ“‹ Log de ExecuÃ§Ã£o</h3>
        <div id="executionLog" class="log">Sistema pronto para testes...\n</div>
    </div>

    <script>
        let clientToken = null;
        let driverToken = null;
        let tripRequestId = null;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('executionLog');
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(type, status, resultClass, message) {
            document.getElementById(`${type}Status`).textContent = status;
            const resultDiv = document.getElementById(`${type}Result`);
            resultDiv.className = `result ${resultClass}`;
            resultDiv.textContent = message;
        }

        async function testClientLogin() {
            log('ğŸ§‘â€ğŸ’¼ Iniciando teste de login do cliente...');
            updateStatus('client', 'Fazendo login...', 'info', 'Conectando...');
            
            try {
                const response = await fetch('/guincho/api/auth/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'cliente@iguincho.com',
                        password: 'teste123'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    clientToken = data.data.session_token;
                    updateStatus('client', 'Logado com sucesso', 'success', 
                        `âœ… ${data.data.user.full_name}\nID: ${data.data.user.id}\nTipo: ${data.data.user.user_type}`);
                    log(`âœ… Cliente logado: ${data.data.user.full_name} (${data.data.user.email})`);
                    return true;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                updateStatus('client', 'Erro no login', 'error', `âŒ ${error.message}`);
                log(`âŒ Erro no login do cliente: ${error.message}`);
                return false;
            }
        }

        async function testDriverLogin() {
            log('ğŸš› Iniciando teste de login do guincheiro...');
            updateStatus('driver', 'Fazendo login...', 'info', 'Conectando...');
            
            try {
                const response = await fetch('/guincho/api/auth/login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'guincheiro@teste.com',
                        password: 'teste123'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    driverToken = data.data.session_token;
                    updateStatus('driver', 'Logado com sucesso', 'success', 
                        `âœ… ${data.data.user.full_name}\nID: ${data.data.user.id}\nTipo: ${data.data.user.user_type}`);
                    log(`âœ… Guincheiro logado: ${data.data.user.full_name} (${data.data.user.email})`);
                    return true;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                updateStatus('driver', 'Erro no login', 'error', `âŒ ${error.message}`);
                log(`âŒ Erro no login do guincheiro: ${error.message}`);
                return false;
            }
        }

        async function createTestTrip() {
            if (!clientToken) {
                log('âŒ Token do cliente necessÃ¡rio para criar viagem');
                return false;
            }
            
            log('ğŸ“ Criando solicitaÃ§Ã£o de viagem de teste...');
            updateStatus('client', 'Criando solicitaÃ§Ã£o...', 'warning', 'Enviando dados...');
            
            try {
                const tripData = {
                    service_type: 'guincho',
                    origin_lat: -23.5505,
                    origin_lng: -46.6333,
                    origin_address: 'PraÃ§a da SÃ©, SÃ£o Paulo, SP',
                    destination_lat: -23.5629,
                    destination_lng: -46.6544,
                    destination_address: 'Parque Ibirapuera, SÃ£o Paulo, SP',
                    client_offer: 85.00
                };
                
                const response = await fetch('/guincho/api/trips/create_request.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + clientToken
                    },
                    body: JSON.stringify(tripData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    tripRequestId = data.data.trip_request_id;
                    updateStatus('client', 'SolicitaÃ§Ã£o criada', 'success', 
                        `âœ… ID: ${tripRequestId}\nğŸ’° R$ ${tripData.client_offer}\nğŸ“ ${data.data.distance_km} km\nğŸ‘¥ ${data.data.nearby_drivers_count} guincheiros notificados`);
                    log(`âœ… SolicitaÃ§Ã£o criada com ID: ${tripRequestId}`);
                    log(`ğŸ“Š Detalhes: ${data.data.distance_km} km, R$ ${tripData.client_offer}, ${data.data.nearby_drivers_count} guincheiros notificados`);
                    return true;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                updateStatus('client', 'Erro na solicitaÃ§Ã£o', 'error', `âŒ ${error.message}`);
                log(`âŒ Erro ao criar solicitaÃ§Ã£o: ${error.message}`);
                return false;
            }
        }

        async function checkDriverRequests() {
            if (!driverToken) {
                log('âŒ Token do guincheiro necessÃ¡rio para verificar solicitaÃ§Ãµes');
                return false;
            }
            
            log('ğŸ” Verificando solicitaÃ§Ãµes disponÃ­veis para o guincheiro...');
            updateStatus('driver', 'Buscando solicitaÃ§Ãµes...', 'info', 'Consultando...');
            
            try {
                const response = await fetch('/guincho/api/trips/get_requests.php', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + driverToken
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const requests = data.data || [];
                    const testRequest = requests.find(req => req.id == tripRequestId);
                    
                    if (testRequest) {
                        updateStatus('driver', 'SolicitaÃ§Ã£o encontrada!', 'success', 
                            `âœ… SolicitaÃ§Ã£o ${tripRequestId} visÃ­vel\nğŸ“ ${testRequest.origin_address}\nğŸ’° R$ ${testRequest.client_offer}\nğŸ“ ${testRequest.distance_km} km`);
                        log(`âœ… SUCESSO! SolicitaÃ§Ã£o ${tripRequestId} apareceu para o guincheiro`);
                        log(`ğŸ“ Origem: ${testRequest.origin_address}`);
                        log(`ğŸ¯ Destino: ${testRequest.destination_address}`);
                        return true;
                    } else {
                        updateStatus('driver', 'SolicitaÃ§Ã£o nÃ£o encontrada', 'warning', 
                            `âš ï¸ ${requests.length} solicitaÃ§Ãµes disponÃ­veis\nMas a solicitaÃ§Ã£o ${tripRequestId} nÃ£o estÃ¡ visÃ­vel`);
                        log(`âš ï¸ SolicitaÃ§Ã£o ${tripRequestId} NÃƒO encontrada entre ${requests.length} disponÃ­veis`);
                        if (requests.length > 0) {
                            log(`ğŸ“‹ SolicitaÃ§Ãµes disponÃ­veis: ${requests.map(r => r.id).join(', ')}`);
                        }
                        return false;
                    }
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                updateStatus('driver', 'Erro na consulta', 'error', `âŒ ${error.message}`);
                log(`âŒ Erro ao consultar solicitaÃ§Ãµes: ${error.message}`);
                return false;
            }
        }

        async function runCompleteTest() {
            log('ğŸ§ª Iniciando teste completo do fluxo Cliente â†’ Guincheiro');
            log('=' + '='.repeat(50));
            
            // Etapa 1: Login do Cliente
            log('ğŸ“ ETAPA 1: Login do Cliente');
            const clientLoggedIn = await testClientLogin();
            if (!clientLoggedIn) {
                log('âŒ TESTE FALHOU: NÃ£o foi possÃ­vel fazer login do cliente');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Etapa 2: Login do Guincheiro
            log('ğŸ“ ETAPA 2: Login do Guincheiro');
            const driverLoggedIn = await testDriverLogin();
            if (!driverLoggedIn) {
                log('âŒ TESTE FALHOU: NÃ£o foi possÃ­vel fazer login do guincheiro');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Etapa 3: Cliente cria solicitaÃ§Ã£o
            log('ğŸ“ ETAPA 3: Cliente cria solicitaÃ§Ã£o');
            const tripCreated = await createTestTrip();
            if (!tripCreated) {
                log('âŒ TESTE FALHOU: NÃ£o foi possÃ­vel criar a solicitaÃ§Ã£o');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Etapa 4: Verificar se aparece para o guincheiro
            log('ğŸ“ ETAPA 4: Verificar se aparece para o guincheiro');
            const requestVisible = await checkDriverRequests();
            
            // Resultado final
            log('=' + '='.repeat(50));
            if (requestVisible) {
                log('ğŸ‰ TESTE COMPLETO PASSOU! âœ…');
                log('   âœ… Cliente conseguiu fazer login');
                log('   âœ… Guincheiro conseguiu fazer login');
                log('   âœ… Cliente criou solicitaÃ§Ã£o com sucesso');
                log('   âœ… SolicitaÃ§Ã£o apareceu para o guincheiro');
                log('');
                log('ğŸš€ SISTEMA FUNCIONANDO PERFEITAMENTE EM PRODUÃ‡ÃƒO!');
            } else {
                log('âŒ TESTE FALHOU!');
                log('   âœ… Cliente conseguiu fazer login');
                log('   âœ… Guincheiro conseguiu fazer login');
                log('   âœ… Cliente criou solicitaÃ§Ã£o com sucesso');
                log('   âŒ SolicitaÃ§Ã£o NÃƒO apareceu para o guincheiro');
                log('');
                log('ğŸ”§ NECESSÃRIO INVESTIGAR O SISTEMA DE NOTIFICAÃ‡Ã•ES');
            }
        }
        
        function clearResults() {
            document.getElementById('executionLog').textContent = 'Sistema pronto para testes...\n';
            updateStatus('client', 'Aguardando teste...', 'info', 'Pronto para testar');
            updateStatus('driver', 'Aguardando teste...', 'info', 'Pronto para testar');
            clientToken = null;
            driverToken = null;
            tripRequestId = null;
        }

        // Auto-run test if in production
        if (window.location.hostname.includes('coppermane')) {
            log('ğŸŒ Detectado ambiente de PRODUÃ‡ÃƒO - Iniciando teste automÃ¡tico em 3 segundos...');
            setTimeout(runCompleteTest, 3000);
        }
    </script>
</body>
</html>