<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Autenticação</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Debug Sistema de Autenticação</h1>
    
    <div id="status" class="debug">
        <h3>Status Atual:</h3>
        <p id="current-status">Carregando...</p>
    </div>
    
    <div>
        <button onclick="clearStorage()">Limpar localStorage</button>
        <button onclick="generateToken()">Gerar Novo Token</button>
        <button onclick="testAPI()">Testar API</button>
        <button onclick="debugToken()">Debug Token</button>
    </div>
    
    <div id="results"></div>
    
    <script src="#"></script>
    <script>
        function log(message, type = 'debug') {
            const div = document.createElement('div');
            div.className = `debug ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            document.getElementById('results').appendChild(div);
        }
        
        function clearStorage() {
            localStorage.clear();
            log('localStorage limpo', 'success');
            updateStatus();
        }
        
        async function generateToken() {
            try {
                const token = await window.authHelper.getAuthToken();
                log(`Token gerado: ${token}`, 'success');
                updateStatus();
            } catch (error) {
                log(`Erro ao gerar token: ${error.message}`, 'error');
            }
        }
        
        async function testAPI() {
            try {
                const token = await window.authHelper.getAuthToken();
                log(`Testando com token: ${token}`);
                
                const response = await fetch('/guincho/api/trips/get_client_requests.php', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                
                const data = await response.json();
                log(`API Response: ${JSON.stringify(data)}`, data.success ? 'success' : 'error');
            } catch (error) {
                log(`Erro na API: ${error.message}`, 'error');
            }
        }
        
        async function debugToken() {
            const token = localStorage.getItem('auth_token');
            const timestamp = localStorage.getItem('token_timestamp');
            const userData = localStorage.getItem('userData');
            
            log(`Token armazenado: ${token || 'Nenhum'}`);
            log(`Timestamp: ${timestamp || 'Nenhum'}`);
            log(`UserData: ${userData || 'Nenhum'}`);
            
            if (timestamp) {
                const tokenTimestamp = parseInt(timestamp);
                const currentTimestamp = Math.floor(Date.now() / 1000);
                const age = currentTimestamp - tokenTimestamp;
                log(`Idade do token: ${age} segundos (${Math.floor(age/3600)} horas)`);
            }
            
            if (token && token.startsWith('test_client_2_')) {
                const parts = token.split('_');
                const tokenTs = parseInt(parts[3]);
                const currentTs = Math.floor(Date.now() / 1000);
                log(`Token timestamp: ${tokenTs}, Atual: ${currentTs}, Diferença: ${currentTs - tokenTs} segundos`);
            }
        }
        
        function updateStatus() {
            const token = localStorage.getItem('auth_token');
            const timestamp = localStorage.getItem('token_timestamp');
            
            let status = 'Sem token';
            if (token) {
                if (timestamp) {
                    const age = Math.floor(Date.now() / 1000) - parseInt(timestamp);
                    status = `Token válido (${Math.floor(age/3600)}h ${Math.floor((age%3600)/60)}m de idade)`;
                } else {
                    status = 'Token sem timestamp';
                }
            }
            
            document.getElementById('current-status').textContent = status;
        }
        
        // Atualizar status ao carregar
        document.addEventListener('DOMContentLoaded', updateStatus);
    </script>
</body>
</html>