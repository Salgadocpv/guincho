<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug APIs</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 20px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .api-test { 
            background: white; 
            margin: 15px 0; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .response { 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            padding: 15px; 
            border-radius: 5px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .url { 
            background: #e9ecef; 
            padding: 5px 10px; 
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>üîç Debug das APIs</h1>
    <p>Vamos testar cada API individualmente para encontrar o problema.</p>
    
    <div class="api-test">
        <h2>1. API de Tokens</h2>
        <div class="url">/guincho/api/debug/simple_tokens.php?action=get_tokens</div>
        <button onclick="testTokensAPI()">üîë Testar API de Tokens</button>
        <div id="tokens-result" class="response">Clique para testar...</div>
    </div>

    <div class="api-test">
        <h2>2. API de Criar Dados de Teste</h2>
        <div class="url">/guincho/api/debug/test_bid_flow_safe.php?action=create_full_test</div>
        <button onclick="testCreateDataAPI()">üéØ Testar Cria√ß√£o de Dados (Vers√£o Segura)</button>
        <div id="create-result" class="response">Clique para testar...</div>
    </div>

    <div class="api-test">
        <h2>3. API de Solicita√ß√µes (Guincheiro)</h2>
        <div class="url">/guincho/api/trips/get_requests.php?lat=-23.5505&lng=-46.6333</div>
        <button onclick="testRequestsAPI()">üöõ Testar API de Solicita√ß√µes</button>
        <div id="requests-result" class="response">Clique para testar...</div>
    </div>

    <div class="api-test">
        <h2>4. API de Propostas (Cliente)</h2>
        <div class="url">/guincho/api/trips/get_bids.php?trip_request_id=1</div>
        <button onclick="testBidsAPI()">üë§ Testar API de Propostas</button>
        <div id="bids-result" class="response">Clique para testar...</div>
    </div>

    <div class="api-test">
        <h2>5. Teste de Conectividade B√°sica</h2>
        <button onclick="testConnectivity()">üåê Testar Conectividade</button>
        <div id="connectivity-result" class="response">Clique para testar...</div>
    </div>

    <script>
        async function testAPI(url, elementId, description) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.innerHTML = `‚è≥ Testando ${description}...\n`;
            
            try {
                console.log(`Testing: ${url}`);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                resultDiv.innerHTML += `Status: ${response.status} ${response.statusText}\n`;
                resultDiv.innerHTML += `Headers: ${JSON.stringify(Object.fromEntries(response.headers), null, 2)}\n`;
                
                const responseText = await response.text();
                resultDiv.innerHTML += `Raw Response Length: ${responseText.length} chars\n`;
                resultDiv.innerHTML += `Raw Response: ${responseText.substring(0, 500)}${responseText.length > 500 ? '...' : ''}\n`;
                
                if (responseText.trim()) {
                    try {
                        const data = JSON.parse(responseText);
                        resultDiv.innerHTML += `‚úÖ JSON v√°lido!\n`;
                        resultDiv.innerHTML += `Parsed: ${JSON.stringify(data, null, 2)}\n`;
                        return { success: true, data };
                    } catch (jsonError) {
                        resultDiv.innerHTML += `‚ùå Erro JSON: ${jsonError.message}\n`;
                        return { success: false, error: 'Invalid JSON', raw: responseText };
                    }
                } else {
                    resultDiv.innerHTML += `‚ùå Resposta vazia!\n`;
                    return { success: false, error: 'Empty response' };
                }
                
            } catch (error) {
                resultDiv.innerHTML += `‚ùå Erro de rede: ${error.message}\n`;
                console.error(`Error testing ${url}:`, error);
                return { success: false, error: error.message };
            }
        }

        async function testTokensAPI() {
            const result = await testAPI(
                '/guincho/api/debug/simple_tokens.php?action=get_tokens',
                'tokens-result',
                'API de Tokens'
            );
            
            if (result.success && result.data.tokens) {
                window.testTokens = result.data.tokens;
                document.getElementById('tokens-result').innerHTML += `\nüéâ Tokens salvos para pr√≥ximos testes!\n`;
            }
        }

        async function testCreateDataAPI() {
            await testAPI(
                '/guincho/api/debug/test_bid_flow_safe.php?action=create_full_test',
                'create-result',
                'Cria√ß√£o de Dados de Teste (Vers√£o Segura)'
            );
        }

        async function testRequestsAPI() {
            await testAPI(
                '/guincho/api/trips/get_requests.php?lat=-23.5505&lng=-46.6333',
                'requests-result',
                'API de Solicita√ß√µes'
            );
        }

        async function testBidsAPI() {
            await testAPI(
                '/guincho/api/trips/get_bids.php?trip_request_id=1',
                'bids-result',
                'API de Propostas'
            );
        }

        async function testConnectivity() {
            const resultDiv = document.getElementById('connectivity-result');
            resultDiv.innerHTML = '‚è≥ Testando conectividade b√°sica...\n';
            
            try {
                // Teste 1: P√°gina est√°tica
                const response1 = await fetch('/guincho/api/debug/simple_test.php');
                const text1 = await response1.text();
                resultDiv.innerHTML += `‚úÖ simple_test.php: ${response1.status} (${text1.length} chars)\n`;
                
                // Teste 2: Arquivo inexistente
                try {
                    const response2 = await fetch('/guincho/api/debug/nonexistent.php');
                    resultDiv.innerHTML += `‚ö†Ô∏è Arquivo inexistente: ${response2.status}\n`;
                } catch (e) {
                    resultDiv.innerHTML += `‚ùå Arquivo inexistente gerou erro: ${e.message}\n`;
                }
                
                // Teste 3: Headers
                const response3 = await fetch(location.href);
                resultDiv.innerHTML += `‚úÖ P√°gina atual: ${response3.status}\n`;
                
                resultDiv.innerHTML += `üåê Conectividade b√°sica OK\n`;
                
            } catch (error) {
                resultDiv.innerHTML += `‚ùå Erro de conectividade: ${error.message}\n`;
            }
        }

        // Auto-start
        window.onload = function() {
            console.log('üîç Debug APIs carregado');
            document.getElementById('tokens-result').innerHTML = '‚úÖ Pronto para testar APIs individuais\nClique nos bot√µes acima para debuggar cada API.';
        };
    </script>
</body>
</html>