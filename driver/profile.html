<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iguincho - Perfil do Guincheiro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="../js/modal-system.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #28a745 0%, #495057 100%);
            min-height: 100vh;
            color: white;
        }

        .header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .header-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .profile-card {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: rgba(255,255,255,0.8);
        }

        .profile-info h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .profile-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .profile-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: inline-block;
        }

        .badge-professional {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid rgba(40, 167, 69, 0.4);
            color: #28a745;
        }

        .badge-status {
            background: rgba(23, 162, 184, 0.2);
            border: 1px solid rgba(23, 162, 184, 0.4);
            color: #17a2b8;
        }

        .form-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255,255,255,0.9);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: rgba(255,255,255,0.8);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #28a745;
            background: rgba(255,255,255,0.15);
        }

        .form-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .form-input:disabled {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.6);
            cursor: not-allowed;
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: #28a745;
            background: rgba(255,255,255,0.15);
        }

        .form-select:disabled {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.6);
            cursor: not-allowed;
        }

        .form-select option {
            background: #495057;
            color: white;
        }

        .readonly-field {
            background: rgba(255,255,255,0.05) !important;
            color: rgba(255,255,255,0.6) !important;
            cursor: not-allowed !important;
        }

        .readonly-label::after {
            content: " (não editável)";
            color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
            font-style: italic;
        }

        .verification-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .status-verified {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-rejected {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #28a745;
            color: white;
        }

        .btn-primary:hover {
            background: #218838;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            align-items: center;
            gap: 8px;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            color: #ff6b6b;
            font-size: 0.8rem;
            margin-top: 4px;
            display: none;
        }

        .form-input.error {
            border-color: #ff6b6b;
        }

        .approval-notice {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.4);
            color: #ffc107;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .approval-notice i {
            font-size: 1.5rem;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .header-title {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <button class="back-button" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="header-title">Meu Perfil Profissional</div>
        </div>
    </div>

    <div class="container">
        <!-- Approval Notice (shown when status is pending) -->
        <div class="approval-notice" id="approvalNotice" style="display: none;">
            <i class="fas fa-hourglass-half"></i>
            <div>
                <strong>Aguardando Aprovação</strong><br>
                Seu perfil está em análise. Algumas informações não podem ser editadas até a aprovação final.
            </div>
        </div>

        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-avatar">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="profile-info">
                    <h2 id="profileName">Carregando...</h2>
                    <div class="profile-badges">
                        <span class="profile-badge badge-professional">
                            <i class="fas fa-shield-alt"></i> Guincheiro
                        </span>
                        <span class="profile-badge badge-status" id="statusBadge">
                            <i class="fas fa-clock"></i> Em Análise
                        </span>
                    </div>
                </div>
            </div>

            <form id="profileForm">
                <!-- Dados Pessoais -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-user"></i>
                        Dados Pessoais
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label readonly-label">Nome Completo</label>
                            <input type="text" class="form-input readonly-field" id="fullName" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label readonly-label">CPF</label>
                            <input type="text" class="form-input readonly-field" id="cpf" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label readonly-label">Data de Nascimento</label>
                            <input type="date" class="form-input readonly-field" id="birthDate" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label readonly-label">CNH</label>
                            <input type="text" class="form-input readonly-field" id="cnh" disabled>
                            <div class="verification-status status-verified">
                                <i class="fas fa-check-circle"></i>
                                Verificado
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label readonly-label">Categoria da CNH</label>
                            <input type="text" class="form-input readonly-field" id="cnhCategory" disabled>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefone</label>
                            <input type="tel" class="form-input" id="phone" placeholder="(11) 99999-9999">
                            <div class="error-message" id="phoneError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">WhatsApp</label>
                            <input type="tel" class="form-input" id="whatsapp" placeholder="(11) 99999-9999">
                            <div class="error-message" id="whatsappError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-mail Profissional</label>
                            <input type="email" class="form-input" id="email" placeholder="seu@email.com">
                            <div class="error-message" id="emailError"></div>
                        </div>
                    </div>
                </div>

                <!-- Informações Profissionais -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-briefcase"></i>
                        Informações Profissionais
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Experiência</label>
                            <select class="form-select" id="experience">
                                <option value="">Selecione</option>
                                <option value="0-1">Menos de 1 ano</option>
                                <option value="1-3">1 a 3 anos</option>
                                <option value="3-5">3 a 5 anos</option>
                                <option value="5-10">5 a 10 anos</option>
                                <option value="10+">Mais de 10 anos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Especialidade</label>
                            <select class="form-select" id="specialty">
                                <option value="">Selecione</option>
                                <option value="carros">Carros de Passeio</option>
                                <option value="motos">Motocicletas</option>
                                <option value="suv">SUVs e Utilitários</option>
                                <option value="caminhoes">Caminhões</option>
                                <option value="todos">Todos os Veículos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Região de Atuação</label>
                            <input type="text" class="form-input" id="workRegion" placeholder="Ex: São Paulo - Centro, Zona Sul">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Disponibilidade</label>
                            <select class="form-select" id="availability">
                                <option value="">Selecione</option>
                                <option value="24h">24 horas</option>
                                <option value="comercial">Horário Comercial (8h-18h)</option>
                                <option value="noturno">Período Noturno (18h-6h)</option>
                                <option value="fds">Finais de Semana</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Informações do Guincho -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-truck"></i>
                        Guincho / Veículo de Trabalho
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label readonly-label">Placa do Guincho</label>
                            <input type="text" class="form-input readonly-field" id="truckPlate" disabled>
                            <div class="verification-status status-verified">
                                <i class="fas fa-check-circle"></i>
                                Verificado
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Marca do Guincho</label>
                            <input type="text" class="form-input" id="truckBrand" placeholder="Ex: Ford, Mercedes">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Modelo</label>
                            <input type="text" class="form-input" id="truckModel" placeholder="Ex: Cargo, Atego">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ano</label>
                            <input type="number" class="form-input" id="truckYear" placeholder="2020" min="1990" max="2025">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Capacidade de Carga</label>
                            <select class="form-select" id="truckCapacity">
                                <option value="">Selecione</option>
                                <option value="leve">Até 1.500kg (carros pequenos)</option>
                                <option value="media">1.500kg - 3.000kg (carros médios/SUVs)</option>
                                <option value="pesada">3.000kg - 6.000kg (caminhonetes/utilitários)</option>
                                <option value="extra">Acima de 6.000kg (caminhões)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Status da Documentação -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-file-alt"></i>
                        Status da Documentação
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Foto de Perfil</label>
                            <div class="verification-status status-verified">
                                <i class="fas fa-check-circle"></i>
                                Aprovado
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CNH</label>
                            <div class="verification-status status-verified">
                                <i class="fas fa-check-circle"></i>
                                Verificado
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CRLV do Guincho</label>
                            <div class="verification-status status-pending">
                                <i class="fas fa-hourglass-half"></i>
                                Em análise
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Foto do Veículo</label>
                            <div class="verification-status status-verified">
                                <i class="fas fa-check-circle"></i>
                                Aprovado
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        <i class="fas fa-undo"></i>
                        <span>Cancelar</span>
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveButton">
                        <span class="btn-text">
                            <i class="fas fa-save"></i>
                            Salvar Alterações
                        </span>
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Salvando...
                        </div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let originalData = {};
        let hasChanges = false;
        let userStatus = 'pending'; // pending, approved, rejected

        // Initialize modal system
        const modalSystem = new ModalSystem();

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
            setupFormValidation();
            setupMasks();
            setupChangeDetection();
        });

        // Load user profile data
        async function loadUserProfile() {
            try {
                const response = await fetch('/guincho/api/profile/get_profile_simple.php?type=driver');

                const result = await response.json();
                
                if (result.success && result.data.user_type === 'driver') {
                    const userData = result.data.profile;
                    
                    // Store original data
                    originalData = { ...userData };
                    userStatus = userData.status || 'pending';

                    // Show approval notice if pending
                    if (userStatus === 'pending') {
                        document.getElementById('approvalNotice').style.display = 'flex';
                    }

                    // Update status badge
                    updateStatusBadge(userStatus);

                    // Populate form
                    populateForm(userData);
                    
                    // Update profile name
                    document.getElementById('profileName').textContent = userData.fullName;
                } else {
                    throw new Error(result.message || 'Erro ao carregar perfil');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                await modalSystem.error('Erro ao carregar perfil: ' + error.message);
            }
        }

        // Update status badge
        function updateStatusBadge(status) {
            const statusBadge = document.getElementById('statusBadge');
            
            switch (status) {
                case 'approved':
                    statusBadge.innerHTML = '<i class="fas fa-check-circle"></i> Aprovado';
                    statusBadge.className = 'profile-badge status-verified';
                    break;
                case 'rejected':
                    statusBadge.innerHTML = '<i class="fas fa-times-circle"></i> Rejeitado';
                    statusBadge.className = 'profile-badge status-rejected';
                    break;
                default:
                    statusBadge.innerHTML = '<i class="fas fa-clock"></i> Em Análise';
                    statusBadge.className = 'profile-badge badge-status';
            }
        }

        // Populate form with data
        function populateForm(data) {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key);
                if (element && key !== 'status') {
                    element.value = data[key];
                }
            });
        }

        // Setup input masks
        function setupMasks() {
            // Phone masks
            ['phone', 'whatsapp'].forEach(id => {
                document.getElementById(id).addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(\d{2})(\d)/, '($1) $2');
                    value = value.replace(/(\d{4,5})(\d{4})$/, '$1-$2');
                    e.target.value = value;
                });
            });
        }

        // Setup form validation
        function setupFormValidation() {
            const form = document.getElementById('profileForm');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                if (validateForm()) {
                    saveProfile();
                }
            });
        }

        // Setup change detection
        function setupChangeDetection() {
            const editableInputs = document.querySelectorAll('.form-input:not(.readonly-field), .form-select');
            
            editableInputs.forEach(input => {
                input.addEventListener('input', detectChanges);
                input.addEventListener('change', detectChanges);
            });
        }

        // Detect changes in form
        function detectChanges() {
            const currentData = getFormData();
            hasChanges = JSON.stringify(currentData) !== JSON.stringify(getOriginalEditableData());
            
            updateSaveButtonState();
        }

        // Get only editable data from original
        function getOriginalEditableData() {
            const { fullName, cpf, birthDate, cnh, cnhCategory, truckPlate, status, ...editableData } = originalData;
            return editableData;
        }

        // Get form data
        function getFormData() {
            const formData = {};
            const editableInputs = document.querySelectorAll('.form-input:not(.readonly-field), .form-select');
            
            editableInputs.forEach(input => {
                if (input.id) {
                    formData[input.id] = input.value;
                }
            });
            
            return formData;
        }

        // Update save button state
        function updateSaveButtonState() {
            const saveButton = document.getElementById('saveButton');
            saveButton.disabled = !hasChanges;
        }

        // Validate form
        function validateForm() {
            let isValid = true;
            
            // Validate email
            const email = document.getElementById('email').value;
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showFieldError('email', 'E-mail inválido');
                isValid = false;
            } else {
                hideFieldError('email');
            }
            
            // Validate phone
            const phone = document.getElementById('phone').value;
            if (phone && phone.replace(/\D/g, '').length < 10) {
                showFieldError('phone', 'Telefone inválido');
                isValid = false;
            } else {
                hideFieldError('phone');
            }
            
            // Validate whatsapp
            const whatsapp = document.getElementById('whatsapp').value;
            if (whatsapp && whatsapp.replace(/\D/g, '').length < 10) {
                showFieldError('whatsapp', 'WhatsApp inválido');
                isValid = false;
            } else {
                hideFieldError('whatsapp');
            }
            
            return isValid;
        }

        // Show field error
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            
            field.classList.add('error');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        // Hide field error
        function hideFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            
            field.classList.remove('error');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        // Save profile
        async function saveProfile() {
            const saveButton = document.getElementById('saveButton');
            const btnText = saveButton.querySelector('.btn-text');
            const loading = saveButton.querySelector('.loading');
            
            // Show loading state
            btnText.style.display = 'none';
            loading.style.display = 'flex';
            saveButton.disabled = true;
            
            try {
                const formData = getFormData();
                
                const response = await fetch('/guincho/api/profile/update_driver_simple.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success) {
                    // Update original data
                    originalData = { ...originalData, ...formData };
                    hasChanges = false;
                    
                    await modalSystem.success('Perfil atualizado com sucesso!\nVocê será redirecionado para o dashboard.');
                    
                    // Disable beforeunload warning for redirect
                    window.removeEventListener('beforeunload', beforeUnloadHandler);
                    
                    // Redirect to dashboard after success
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1500);
                } else {
                    throw new Error(result.message || 'Erro ao salvar perfil');
                }
                
            } catch (error) {
                console.error('Error saving profile:', error);
                await modalSystem.error('Erro ao salvar perfil: ' + error.message);
            } finally {
                // Reset button state
                btnText.style.display = 'flex';
                loading.style.display = 'none';
                updateSaveButtonState();
            }
        }

        // Reset form to original values
        function resetForm() {
            populateForm(originalData);
            hasChanges = false;
            updateSaveButtonState();
            
            // Clear all error states
            document.querySelectorAll('.form-input.error').forEach(input => {
                input.classList.remove('error');
            });
            document.querySelectorAll('.error-message').forEach(error => {
                error.style.display = 'none';
            });
        }

        // Go back
        function goBack() {
            if (hasChanges) {
                modalSystem.confirm(
                    'Alterações não salvas',
                    'Você possui alterações não salvas. Deseja sair mesmo assim?'
                ).then(confirmed => {
                    if (confirmed) {
                        window.history.back();
                    }
                });
            } else {
                window.history.back();
            }
        }

        // Handle page unload
        function beforeUnloadHandler(e) {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        }
        
        window.addEventListener('beforeunload', beforeUnloadHandler);
    </script>
</body>
</html>