<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Login - Iguincho</title>
    <script src="js/modal-system.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .debug-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn { padding: 12px 24px; margin: 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .log { background: #f8f9fa; border-left: 4px solid #007bff; padding: 12px; margin: 8px 0; font-family: monospace; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        #consoleLog { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>🐛 Debug Completo do Login</h1>
    
    <div class="debug-section">
        <h3>1. Teste dos Botões Quick Login</h3>
        <button class="btn" onclick="debugQuickLogin('client')">🧪 Debug Cliente</button>
        <button class="btn" onclick="debugQuickLogin('driver')">🧪 Debug Guincheiro</button>
        <button class="btn" onclick="debugQuickLogin('admin')">🧪 Debug Admin</button>
        <button class="btn" onclick="clearLogs()">🧹 Limpar Logs</button>
    </div>
    
    <div class="debug-section">
        <h3>2. Console de Debug</h3>
        <div id="consoleLog"></div>
    </div>
    
    <div class="debug-section">
        <h3>3. Teste Manual</h3>
        <input type="email" id="testEmail" placeholder="Email" style="padding: 8px; margin: 4px; width: 200px;">
        <input type="password" id="testPassword" placeholder="Senha" style="padding: 8px; margin: 4px; width: 200px;">
        <button class="btn" onclick="manualLogin()">🧪 Teste Manual</button>
    </div>
    
    <div class="debug-section">
        <h3>4. Informações do Sistema</h3>
        <div id="systemInfo"></div>
        <button class="btn" onclick="showSystemInfo()">📊 Mostrar Info</button>
    </div>

    <p><a href="index.html" style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">← Voltar para Login Original</a></p>

    <script>
        // Console de debug customizado
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };

        function logToPage(message, type = 'log') {
            const logDiv = document.getElementById('consoleLog');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Também log no console real
            originalConsole[type]?.(message) || originalConsole.log(message);
        }

        function clearLogs() {
            document.getElementById('consoleLog').innerHTML = '';
        }

        // Override console methods
        console.log = (msg) => logToPage(msg, 'log');
        console.error = (msg) => logToPage(msg, 'error'); 
        console.warn = (msg) => logToPage(msg, 'warning');

        // Função de debug do quickLogin
        function debugQuickLogin(userType) {
            console.log(`🚀 Iniciando debugQuickLogin(${userType})`);
            
            const credentials = {
                client: { email: 'cliente@iguincho.com', password: 'teste123' },
                driver: { email: 'guincheiro@iguincho.com', password: 'teste123' },
                admin: { email: 'admin@iguincho.com', password: 'admin123' }
            };

            if (!credentials[userType]) {
                console.error(`❌ Tipo de usuário inválido: ${userType}`);
                return;
            }

            console.log(`📧 Credenciais: ${credentials[userType].email} / ${'*'.repeat(credentials[userType].password.length)}`);

            // Verificar se modalSystem existe
            console.log(`🎭 modalSystem disponível: ${typeof modalSystem !== 'undefined'}`);

            // Simular preenchimento de campos
            console.log('📝 Simulando preenchimento de campos...');
            
            // Executar login
            debugPerformLogin(credentials[userType].email, credentials[userType].password);
        }

        // Função de debug do performLogin
        async function debugPerformLogin(email, password) {
            console.log(`🔐 Iniciando debugPerformLogin`);
            console.log(`📨 Email: ${email}`);
            console.log(`🔒 Password: ${'*'.repeat(password.length)}`);
            
            try {
                console.log('🌐 Iniciando fetch para api/auth/login.php...');
                
                const requestBody = JSON.stringify({ email, password });
                console.log(`📤 Request body: ${requestBody}`);
                
                const startTime = Date.now();
                
                const response = await fetch('api/auth/login.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: requestBody
                });
                
                const endTime = Date.now();
                console.log(`⏱️ Tempo de resposta: ${endTime - startTime}ms`);
                console.log(`📊 Status HTTP: ${response.status} ${response.statusText}`);
                console.log(`🌐 URL: ${response.url}`);
                
                // Mostrar headers
                console.log('📋 Response Headers:');
                for (let [key, value] of response.headers) {
                    console.log(`   ${key}: ${value}`);
                }
                
                // Ler resposta
                const responseText = await response.text();
                console.log(`📄 Response Text (${responseText.length} chars): ${responseText.substring(0, 200)}${responseText.length > 200 ? '...' : ''}`);
                
                // Tentar parsear JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('✅ JSON válido parseado');
                    console.log(`📊 Response data: ${JSON.stringify(data, null, 2)}`);
                } catch (e) {
                    console.error(`❌ Erro ao parsear JSON: ${e.message}`);
                    console.error(`📄 Raw response: ${responseText}`);
                    return;
                }
                
                // Analisar resposta
                if (data.success) {
                    console.log('🎉 LOGIN BEM-SUCEDIDO!');
                    console.log(`👤 User type: ${data.data?.user?.user_type}`);
                    console.log(`🎫 Session token: ${data.data?.session_token ? data.data.session_token.substring(0, 20) + '...' : 'N/A'}`);
                    
                    // Simular redirecionamento
                    const userType = data.data?.user?.user_type;
                    const redirectMap = {
                        'client': 'services.html',
                        'driver': 'driver/dashboard.html', 
                        'admin': 'admin/dashboard.html'
                    };
                    const redirectUrl = redirectMap[userType] || 'services.html';
                    console.log(`🔄 Redirecionaria para: ${redirectUrl}`);
                    
                } else {
                    console.error('❌ LOGIN FALHOU!');
                    console.error(`📝 Mensagem: ${data.message || 'Erro desconhecido'}`);
                }
                
            } catch (error) {
                console.error('💥 ERRO NA REQUISIÇÃO!');
                console.error(`📝 Mensagem: ${error.message}`);
                console.error(`📚 Stack trace: ${error.stack}`);
            }
        }

        // Teste manual
        function manualLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            if (!email || !password) {
                console.warn('⚠️ Email ou senha em branco');
                return;
            }
            
            console.log('🧪 Iniciando teste manual...');
            debugPerformLogin(email, password);
        }

        // Informações do sistema
        function showSystemInfo() {
            const info = {
                userAgent: navigator.userAgent,
                url: window.location.href,
                protocol: window.location.protocol,
                host: window.location.host,
                pathname: window.location.pathname,
                cookies: document.cookie || 'Nenhum cookie',
                localStorage: `${Object.keys(localStorage).length} itens`,
                sessionStorage: `${Object.keys(sessionStorage).length} itens`,
                fetchSupported: typeof fetch !== 'undefined',
                promiseSupported: typeof Promise !== 'undefined',
                modalSystemLoaded: typeof modalSystem !== 'undefined',
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language
            };
            
            document.getElementById('systemInfo').innerHTML = 
                '<pre>' + JSON.stringify(info, null, 2) + '</pre>';
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Debug page carregada');
            showSystemInfo();
        });
    </script>
</body>
</html>