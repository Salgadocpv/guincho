<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Cancelar Viagem</title>
    <script src="js/modal-system.js"></script>
</head>
<body>
    <h1>Teste de Cancelamento de Viagem</h1>
    <button id="testButton" onclick="testCancel()">Testar Cancelamento (ID Din√¢mico)</button>
    <button id="createTripButton" onclick="createTestTrip()">Criar Nova Viagem de Teste</button>
    <div id="output" style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px;"></div>

    <script>
        // Initialize modal system
        const modalSystem = new ModalSystem();
        
        let currentTripId = null;
        
        async function createTestTrip() {
            const output = document.getElementById('output');
            output.innerHTML = 'Criando viagem de teste...';
            
            try {
                const response = await fetch('api/debug/force_new_trip.php');
                const data = await response.json();
                
                if (data.success) {
                    currentTripId = data.created_data.trip_request_id;
                    output.innerHTML = `‚úÖ <strong>Viagem criada com sucesso!</strong><br>
                                      ID: ${currentTripId}<br>
                                      Status: ${data.created_data.status}<br>
                                      <em>Agora voc√™ pode testar o cancelamento.</em>`;
                } else {
                    output.innerHTML = '‚ùå <strong>Erro:</strong> ' + data.message;
                }
            } catch (error) {
                output.innerHTML = '‚ùå <strong>Erro:</strong> ' + error.message;
            }
        }

        async function testCancel() {
            const output = document.getElementById('output');
            
            if (!currentTripId) {
                output.innerHTML = '‚ö†Ô∏è <strong>Aviso:</strong> Crie uma viagem de teste primeiro!';
                return;
            }
            
            output.innerHTML = 'Testando cancelamento...';
            
            try {
                console.log('cancelActiveTrip called with ID:', currentTripId);
                
                let confirmed;
                try {
                    confirmed = await modalSystem.confirm(
                        'Tem certeza que deseja cancelar esta viagem? O guincheiro ser√° liberado automaticamente.',
                        'Cancelar Viagem Ativa'
                    );
                } catch (error) {
                    console.error('Error with modal confirm:', error);
                    confirmed = confirm('Tem certeza que deseja cancelar esta viagem? O guincheiro ser√° liberado automaticamente.');
                }
                
                console.log('User confirmed:', confirmed);
                if (!confirmed) {
                    output.innerHTML = 'Cancelamento cancelado pelo usu√°rio.';
                    return;
                }

                console.log('Getting auth token...');
                const token = null;
                console.log('Token obtained:', token ? 'Yes' : 'No');
                
                console.log('Making API request...');
                const response = await fetch('api/trips/cancel_active_trip.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ trip_request_id: currentTripId })
                });

                console.log('API response status:', response.status);
                const data = await response.json();
                console.log('API response data:', data);

                if (data.success) {
                    console.log('Success! Showing success message...');
                    await modalSystem.success('Viagem cancelada com sucesso! O guincheiro foi liberado.');
                    output.innerHTML = '<strong>SUCESSO:</strong> ' + data.message;
                } else {
                    throw new Error(data.message || 'Erro ao cancelar viagem');
                }

            } catch (error) {
                console.error('Error cancelling active trip:', error);
                output.innerHTML = '<strong>ERRO:</strong> ' + error.message;
                await modalSystem.error('Erro ao cancelar viagem: ' + error.message);
            }
        }
        
        // Show current auth token on page load and create a test trip
        window.addEventListener('DOMContentLoaded', async () => {
            const token = null;
            document.getElementById('output').innerHTML = 'Token carregado: ' + (token ? token.substring(0, 20) + '...' : 'Nenhum') + '<br><br>üöÄ <em>Clique em "Criar Nova Viagem de Teste" para come√ßar!</em>';
        });
    </script>
</body>
</html>